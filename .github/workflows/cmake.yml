name: C/C++ CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-linux:

    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v4
      with:
        python-version: '3.7.14'
    - name: "Install sckit-ci-addons"
      run: |
        pip install -U "scikit-ci-addons>=0.22.0"

    - name: "Install jsondiff"
      run: pip install jsondiff
    - name: "Install cmake"
      run: |
        sudo apt-get update
        sudo apt-get install rsync
        ci_addons circle/install_cmake 3.16.3
    - name: "Build dcmqi"
      run: |
        cd docker && make dcmqi
  
  build-windows:
    
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - uses: microsoft/setup-msbuild@v1.1
        with:
          vs-version: '17'
          msbuild-architecture: x64
        
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8.0'
      
      - name: Download prerequisites
        run: |
          $client = new-object System.Net.WebClient;
          $client.DownloadFile("https://github.com/QIICR/dicom3tools/releases/download/20200512090031/dicom3tools_winexe_1.00.snapshot.20200512090031.zip", "C:\dicom3tools.zip")
          $client.DownloadFile("https://github.com/QIICR/zlib-dcmqi/releases/download/zlib-dcmqi-1.2.3-VS17-Win64-Release-static/zlib-dcmqi.zip", "C:\zlib-dcmqi.zip")
          $client.DownloadFile("https://github.com/QIICR/dcmtk-dcmqi/releases/download/DCMTK-dcmqi-3.6.7_20220105-VS12-Win64-Release-v0.0.32-static/DCMTK-dcmqi.zip", "C:\DCMTK-dcmqi.zip")
          $client.DownloadFile("https://github.com/QIICR/ITK-dcmqi/releases/download/ITK-dcmqi-VS17-Win64-Release-v0.0.40-static/ITK-dcmqi.zip", "C:\ITK-dcmqi.zip")
        shell: pwsh
